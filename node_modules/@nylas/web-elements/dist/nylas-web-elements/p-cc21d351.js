/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
class t{constructor(t){this._map=new Map;this._roundAverageSize=false;this.totalSize=0;if(t?.roundAverageSize===true){this._roundAverageSize=true}}set(t,i){const s=this._map.get(t)||0;this._map.set(t,i);this.totalSize+=i-s}get averageSize(){if(this._map.size>0){const t=this.totalSize/this._map.size;return this._roundAverageSize?Math.round(t):t}return 0}getSize(t){return this._map.get(t)}clear(){this._map.clear();this.totalSize=0}}
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function i(t){return t==="horizontal"?"width":"height"}class s{_getDefaultConfig(){return{direction:"vertical"}}constructor(t,i){this._latestCoords={left:0,top:0};this._direction=null;this._viewportSize={width:0,height:0};this.totalScrollSize={width:0,height:0};this.offsetWithinScroller={left:0,top:0};this._pendingReflow=false;this._pendingLayoutUpdate=false;this._pin=null;this._firstVisible=0;this._lastVisible=0;this._physicalMin=0;this._physicalMax=0;this._first=-1;this._last=-1;this._sizeDim="height";this._secondarySizeDim="width";this._positionDim="top";this._secondaryPositionDim="left";this._scrollPosition=0;this._scrollError=0;this._items=[];this._scrollSize=1;this._overhang=1e3;this._hostSink=t;Promise.resolve().then((()=>this.config=i||this._getDefaultConfig()))}set config(t){Object.assign(this,Object.assign({},this._getDefaultConfig(),t))}get config(){return{direction:this.direction}}get items(){return this._items}set items(t){this._setItems(t)}_setItems(t){if(t!==this._items){this._items=t;this._scheduleReflow()}}get direction(){return this._direction}set direction(t){t=t==="horizontal"?t:"vertical";if(t!==this._direction){this._direction=t;this._sizeDim=t==="horizontal"?"width":"height";this._secondarySizeDim=t==="horizontal"?"height":"width";this._positionDim=t==="horizontal"?"left":"top";this._secondaryPositionDim=t==="horizontal"?"top":"left";this._triggerReflow()}}get viewportSize(){return this._viewportSize}set viewportSize(t){const{_viewDim1:i,_viewDim2:s}=this;Object.assign(this._viewportSize,t);if(s!==this._viewDim2){this._scheduleLayoutUpdate()}else if(i!==this._viewDim1){this._checkThresholds()}}get viewportScroll(){return this._latestCoords}set viewportScroll(t){Object.assign(this._latestCoords,t);const i=this._scrollPosition;this._scrollPosition=this._latestCoords[this._positionDim];const s=Math.abs(i-this._scrollPosition);if(s>=1){this._checkThresholds()}}reflowIfNeeded(t=false){if(t||this._pendingReflow){this._pendingReflow=false;this._reflow()}}set pin(t){this._pin=t;this._triggerReflow()}get pin(){if(this._pin!==null){const{index:t,block:i}=this._pin;return{index:Math.max(0,Math.min(t,this.items.length-1)),block:i}}return null}_clampScrollPosition(t){return Math.max(-this.offsetWithinScroller[this._positionDim],Math.min(t,this.totalScrollSize[i(this.direction)]-this._viewDim1))}unpin(){if(this._pin!==null){this._sendUnpinnedMessage();this._pin=null}}_updateLayout(){}get _viewDim1(){return this._viewportSize[this._sizeDim]}get _viewDim2(){return this._viewportSize[this._secondarySizeDim]}_scheduleReflow(){this._pendingReflow=true}_scheduleLayoutUpdate(){this._pendingLayoutUpdate=true;this._scheduleReflow()}_triggerReflow(){this._scheduleLayoutUpdate();Promise.resolve().then((()=>this.reflowIfNeeded()))}_reflow(){if(this._pendingLayoutUpdate){this._updateLayout();this._pendingLayoutUpdate=false}this._updateScrollSize();this._setPositionFromPin();this._getActiveItems();this._updateVisibleIndices();this._sendStateChangedMessage()}_setPositionFromPin(){if(this.pin!==null){const t=this._scrollPosition;const{index:i,block:s}=this.pin;this._scrollPosition=this._calculateScrollIntoViewPosition({index:i,block:s||"start"})-this.offsetWithinScroller[this._positionDim];this._scrollError=t-this._scrollPosition}}_calculateScrollIntoViewPosition(t){const{block:i}=t;const s=Math.min(this.items.length,Math.max(0,t.index));const h=this._getItemPosition(s)[this._positionDim];let e=h;if(i!=="start"){const t=this._getItemSize(s)[this._sizeDim];if(i==="center"){e=h-.5*this._viewDim1+.5*t}else{const s=h-this._viewDim1+t;if(i==="end"){e=s}else{const t=this._scrollPosition;e=Math.abs(t-h)<Math.abs(t-s)?h:s}}}e+=this.offsetWithinScroller[this._positionDim];return this._clampScrollPosition(e)}getScrollIntoViewCoordinates(t){return{[this._positionDim]:this._calculateScrollIntoViewPosition(t)}}_sendUnpinnedMessage(){this._hostSink({type:"unpinned"})}_sendVisibilityChangedMessage(){this._hostSink({type:"visibilityChanged",firstVisible:this._firstVisible,lastVisible:this._lastVisible})}_sendStateChangedMessage(){const t=new Map;if(this._first!==-1&&this._last!==-1){for(let i=this._first;i<=this._last;i++){t.set(i,this._getItemPosition(i))}}const i={type:"stateChanged",scrollSize:{[this._sizeDim]:this._scrollSize,[this._secondarySizeDim]:null},range:{first:this._first,last:this._last,firstVisible:this._firstVisible,lastVisible:this._lastVisible},childPositions:t};if(this._scrollError){i.scrollError={[this._positionDim]:this._scrollError,[this._secondaryPositionDim]:0};this._scrollError=0}this._hostSink(i)}get _num(){if(this._first===-1||this._last===-1){return 0}return this._last-this._first+1}_checkThresholds(){if(this._viewDim1===0&&this._num>0||this._pin!==null){this._scheduleReflow()}else{const t=Math.max(0,this._scrollPosition-this._overhang);const i=Math.min(this._scrollSize,this._scrollPosition+this._viewDim1+this._overhang);if(this._physicalMin>t||this._physicalMax<i){this._scheduleReflow()}else{this._updateVisibleIndices({emit:true})}}}_updateVisibleIndices(t){if(this._first===-1||this._last===-1)return;let i=this._first;while(i<this._last&&Math.round(this._getItemPosition(i)[this._positionDim]+this._getItemSize(i)[this._sizeDim])<=Math.round(this._scrollPosition)){i++}let s=this._last;while(s>this._first&&Math.round(this._getItemPosition(s)[this._positionDim])>=Math.round(this._scrollPosition+this._viewDim1)){s--}if(i!==this._firstVisible||s!==this._lastVisible){this._firstVisible=i;this._lastVisible=s;if(t&&t.emit){this._sendVisibilityChangedMessage()}}}}
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const h=t=>Object.assign({type:a},t);function e(t){return t==="horizontal"?"marginLeft":"marginTop"}function n(t){return t==="horizontal"?"marginRight":"marginBottom"}function r(t){return t==="horizontal"?"xOffset":"yOffset"}function l(t,i){const s=[t,i].sort();return s[1]<=0?Math.min(...s):s[0]>=0?Math.max(...s):s[0]+s[1]}class o{constructor(){this._childSizeCache=new t;this._marginSizeCache=new t;this._metricsCache=new Map}update(t,s){const h=new Set;Object.keys(t).forEach((e=>{const n=Number(e);this._metricsCache.set(n,t[n]);this._childSizeCache.set(n,t[n][i(s)]);h.add(n);h.add(n+1)}));for(const t of h){const i=this._metricsCache.get(t)?.[e(s)]||0;const h=this._metricsCache.get(t-1)?.[n(s)]||0;this._marginSizeCache.set(t,l(i,h))}}get averageChildSize(){return this._childSizeCache.averageSize}get totalChildSize(){return this._childSizeCache.totalSize}get averageMarginSize(){return this._marginSizeCache.averageSize}get totalMarginSize(){return this._marginSizeCache.totalSize}getLeadingMarginValue(t,i){return this._metricsCache.get(t)?.[e(i)]||0}getChildSize(t){return this._childSizeCache.getSize(t)}getMarginSize(t){return this._marginSizeCache.getSize(t)}clear(){this._childSizeCache.clear();this._marginSizeCache.clear();this._metricsCache.clear()}}class a extends s{constructor(){super(...arguments);this._itemSize={width:100,height:100};this._physicalItems=new Map;this._newPhysicalItems=new Map;this._metricsCache=new o;this._anchorIdx=null;this._anchorPos=null;this._stable=true;this._measureChildren=true;this._estimate=true}get measureChildren(){return this._measureChildren}updateItemSizes(t){this._metricsCache.update(t,this.direction);this._scheduleReflow()}_getPhysicalItem(t){return this._newPhysicalItems.get(t)??this._physicalItems.get(t)}_getSize(t){const i=this._getPhysicalItem(t);return i&&this._metricsCache.getChildSize(t)}_getAverageSize(){return this._metricsCache.averageChildSize||this._itemSize[this._sizeDim]}_estimatePosition(t){const i=this._metricsCache;if(this._first===-1||this._last===-1){return i.averageMarginSize+t*(i.averageMarginSize+this._getAverageSize())}else{if(t<this._first){const s=this._first-t;const h=this._getPhysicalItem(this._first);return h.pos-(i.getMarginSize(this._first-1)||i.averageMarginSize)-(s*i.averageChildSize+(s-1)*i.averageMarginSize)}else{const s=t-this._last;const h=this._getPhysicalItem(this._last);return h.pos+(i.getChildSize(this._last)||i.averageChildSize)+(i.getMarginSize(this._last)||i.averageMarginSize)+s*(i.averageChildSize+i.averageMarginSize)}}}_getPosition(t){const i=this._getPhysicalItem(t);const{averageMarginSize:s}=this._metricsCache;return t===0?this._metricsCache.getMarginSize(0)??s:i?i.pos:this._estimatePosition(t)}_calculateAnchor(t,i){if(t<=0){return 0}if(i>this._scrollSize-this._viewDim1){return this.items.length-1}return Math.max(0,Math.min(this.items.length-1,Math.floor((t+i)/2/this._delta)))}_getAnchor(t,i){if(this._physicalItems.size===0){return this._calculateAnchor(t,i)}if(this._first<0){return this._calculateAnchor(t,i)}if(this._last<0){return this._calculateAnchor(t,i)}const s=this._getPhysicalItem(this._first),h=this._getPhysicalItem(this._last),e=s.pos,n=h.pos,r=n+this._metricsCache.getChildSize(this._last);if(r<t){return this._calculateAnchor(t,i)}if(e>i){return this._calculateAnchor(t,i)}let l=this._firstVisible-1;let o=-Infinity;while(o<t){const t=this._getPhysicalItem(++l);o=t.pos+this._metricsCache.getChildSize(l)}return l}_getActiveItems(){if(this._viewDim1===0||this.items.length===0){this._clearItems()}else{this._getItems()}}_clearItems(){this._first=-1;this._last=-1;this._physicalMin=0;this._physicalMax=0;const t=this._newPhysicalItems;this._newPhysicalItems=this._physicalItems;this._newPhysicalItems.clear();this._physicalItems=t;this._stable=true}_getItems(){const t=this._newPhysicalItems;this._stable=true;let i,s;if(this.pin!==null){const{index:t}=this.pin;this._anchorIdx=t;this._anchorPos=this._getPosition(t)}i=this._scrollPosition-this._overhang;s=this._scrollPosition+this._viewDim1+this._overhang;if(s<0||i>this._scrollSize){this._clearItems();return}if(this._anchorIdx===null||this._anchorPos===null){this._anchorIdx=this._getAnchor(i,s);this._anchorPos=this._getPosition(this._anchorIdx)}let h=this._getSize(this._anchorIdx);if(h===undefined){this._stable=false;h=this._getAverageSize()}const e=this._metricsCache.getMarginSize(this._anchorIdx)??this._metricsCache.averageMarginSize;const n=this._metricsCache.getMarginSize(this._anchorIdx+1)??this._metricsCache.averageMarginSize;if(this._anchorIdx===0){this._anchorPos=e}if(this._anchorIdx===this.items.length-1){this._anchorPos=this._scrollSize-n-h}let r=0;if(this._anchorPos+h+n<i){r=i-(this._anchorPos+h+n)}if(this._anchorPos-e>s){r=s-(this._anchorPos-e)}if(r){this._scrollPosition-=r;i-=r;s-=r;this._scrollError+=r}t.set(this._anchorIdx,{pos:this._anchorPos,size:h});this._first=this._last=this._anchorIdx;this._physicalMin=this._anchorPos-e;this._physicalMax=this._anchorPos+h+n;while(this._physicalMin>i&&this._first>0){let i=this._getSize(--this._first);if(i===undefined){this._stable=false;i=this._getAverageSize()}let s=this._metricsCache.getMarginSize(this._first);if(s===undefined){this._stable=false;s=this._metricsCache.averageMarginSize}this._physicalMin-=i;const h=this._physicalMin;t.set(this._first,{pos:h,size:i});this._physicalMin-=s;if(this._stable===false&&this._estimate===false){break}}while(this._physicalMax<s&&this._last<this.items.length-1){let i=this._getSize(++this._last);if(i===undefined){this._stable=false;i=this._getAverageSize()}let s=this._metricsCache.getMarginSize(this._last);if(s===undefined){this._stable=false;s=this._metricsCache.averageMarginSize}const h=this._physicalMax;t.set(this._last,{pos:h,size:i});this._physicalMax+=i+s;if(!this._stable&&!this._estimate){break}}const l=this._calculateError();if(l){this._physicalMin-=l;this._physicalMax-=l;this._anchorPos-=l;this._scrollPosition-=l;t.forEach((t=>t.pos-=l));this._scrollError+=l}if(this._stable){this._newPhysicalItems=this._physicalItems;this._newPhysicalItems.clear();this._physicalItems=t}}_calculateError(){if(this._first===0){return this._physicalMin}else if(this._physicalMin<=0){return this._physicalMin-this._first*this._delta}else if(this._last===this.items.length-1){return this._physicalMax-this._scrollSize}else if(this._physicalMax>=this._scrollSize){return this._physicalMax-this._scrollSize+(this.items.length-1-this._last)*this._delta}return 0}_reflow(){const{_first:t,_last:i}=this;super._reflow();if(this._first===-1&&this._last==-1||this._first===t&&this._last===i){this._resetReflowState()}}_resetReflowState(){this._anchorIdx=null;this._anchorPos=null;this._stable=true}_updateScrollSize(){const{averageMarginSize:t}=this._metricsCache;this._scrollSize=Math.max(1,this.items.length*(t+this._getAverageSize())+t)}get _delta(){const{averageMarginSize:t}=this._metricsCache;return this._getAverageSize()+t}_getItemPosition(t){return{[this._positionDim]:this._getPosition(t),[this._secondaryPositionDim]:0,[r(this.direction)]:-(this._metricsCache.getLeadingMarginValue(t,this.direction)??this._metricsCache.averageMarginSize)}}_getItemSize(t){return{[this._sizeDim]:this._getSize(t)||this._getAverageSize(),[this._secondarySizeDim]:this._itemSize[this._secondarySizeDim]}}_viewDim2Changed(){this._metricsCache.clear();this._scheduleReflow()}}export{a as FlowLayout,h as flow};
//# sourceMappingURL=p-cc21d351.js.map