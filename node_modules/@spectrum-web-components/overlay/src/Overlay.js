"use strict";var P=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var n=(v,h,e,t)=>{for(var i=t>1?void 0:t?w(h,e):h,r=v.length-1,s;r>=0;r--)(s=v[r])&&(i=(t?s(h,e,i):s(i))||i);return t&&i&&P(h,e,i),i};import{html as u}from"@spectrum-web-components/base";import{property as l,query as f,queryAssignedElements as C,state as D}from"@spectrum-web-components/base/src/decorators.js";import{isAndroid as S,isIOS as A}from"@spectrum-web-components/shared/src/platform.js";import{ElementResolutionController as R,elementResolverUpdatedSymbol as O}from"@spectrum-web-components/reactive-controllers/src/ElementResolution.js";import{conditionAttributeWithId as g}from"@spectrum-web-components/base/src/condition-attribute-with-id.js";import{ifDefined as m,styleMap as b}from"@spectrum-web-components/base/src/directives.js";import{AbstractOverlay as M,nextFrame as E}from"./AbstractOverlay.js";import{OverlayDialog as N}from"./OverlayDialog.js";import{OverlayPopover as H}from"./OverlayPopover.js";import{OverlayNoPopover as k}from"./OverlayNoPopover.js";import{overlayStack as y}from"./OverlayStack.js";import{noop as d}from"./AbstractOverlay.js";import{VirtualTrigger as T}from"./VirtualTrigger.js";import{PlacementController as $}from"./PlacementController.js";import I from"./overlay.css.js";const V=300,F=300;export const LONGPRESS_INSTRUCTIONS={touch:"Double tap and long press for additional options",keyboard:"Press Space or Alt+Down Arrow for additional options",mouse:"Click and hold for additional options"};const U="showPopover"in document.createElement("div");let c=N(M);U?c=H(c):c=k(c);const o=class o extends c{constructor(){super(...arguments);this._delayed=!1;this._disabled=!1;this.longpressState="null";this.offset=6;this.placementController=new $(this);this._open=!1;this.receivesFocus="auto";this.releaseAriaDescribedby=d;this.releaseLongpressDescribedby=d;this._state="closed";this.triggerElement=null;this.type="auto";this.wasOpen=!1;this.elementResolver=new R(this);this.closeOnFocusOut=e=>{if(!e.relatedTarget)return;const t=new Event("overlay-relation-query",{bubbles:!0,composed:!0});e.relatedTarget.addEventListener(t.type,i=>{i.composedPath().includes(this)||(this.open=!1)}),e.relatedTarget.dispatchEvent(t)};this.elementIds=[];this.handlePointerdown=e=>{if(!this.triggerElement||e.button!==0)return;const t=this.triggerElement;this.longpressState="potential",document.addEventListener("pointerup",this.handlePointerup),document.addEventListener("pointercancel",this.handlePointerup),!t.holdAffordance&&(this.longressTimeout=setTimeout(()=>{t&&t.dispatchEvent(new CustomEvent("longpress",{bubbles:!0,composed:!0,detail:{source:"pointer"}}))},V))};this.handlePointerup=()=>{clearTimeout(this.longressTimeout),this.triggerElement&&(this.longpressState=this.state==="opening"?"pressed":"null",document.removeEventListener("pointerup",this.handlePointerup),document.removeEventListener("pointercancel",this.handlePointerup))};this.handleKeydown=e=>{const{code:t,altKey:i}=e;(t==="Space"||i&&t==="ArrowDown")&&t==="ArrowDown"&&(e.stopPropagation(),e.stopImmediatePropagation())};this.handleKeyup=e=>{const{code:t,altKey:i}=e;if(t==="Space"||i&&t==="ArrowDown"){if(!this.triggerElement||!this.hasNonVirtualTrigger)return;e.stopPropagation(),this.triggerElement.dispatchEvent(new CustomEvent("longpress",{bubbles:!0,composed:!0,detail:{source:"keyboard"}})),setTimeout(()=>{this.longpressState="null"})}};this.preventNextToggle=!1;this.handlePointerdownForClick=()=>{this.preventNextToggle=this.open};this.handleClick=()=>{this.longpressState==="opening"||this.longpressState==="pressed"||(this.preventNextToggle||(this.open=!this.open),this.preventNextToggle=!1)};this.focusedin=!1;this.handleFocusin=()=>{this.open=!0,this.focusedin=!0};this.handleFocusout=()=>{this.focusedin=!1,!this.pointerentered&&(this.open=!1)};this.pointerentered=!1;this.handlePointerenter=()=>{this.hoverTimeout&&(clearTimeout(this.hoverTimeout),delete this.hoverTimeout),!this.disabled&&(this.open=!0,this.pointerentered=!0)};this.handleOverlayPointerenter=()=>{this.hoverTimeout&&(clearTimeout(this.hoverTimeout),delete this.hoverTimeout)};this.handlePointerleave=()=>{this.doPointerleave()};this.handleOverlayPointerleave=()=>{this.doPointerleave()};this.handleLongpress=()=>{this.open=!0,this.longpressState=this.longpressState==="potential"?"opening":"pressed"}}get delayed(){var e;return((e=this.elements.at(-1))==null?void 0:e.hasAttribute("delayed"))||this._delayed}set delayed(e){this._delayed=e}get disabled(){return this._disabled}set disabled(e){this._disabled=e,e?(this.hasNonVirtualTrigger&&this.unbindEvents(),this.wasOpen=this.open,this.open=!1):(this.bindEvents(),this.open=this.open||this.wasOpen,this.wasOpen=!1)}get hasNonVirtualTrigger(){return!!this.triggerElement&&!(this.triggerElement instanceof T)}get open(){return this._open}set open(e){e&&this.disabled||e!==this.open&&((this.longpressState==="opening"||this.longpressState==="pressed")&&!e||(this._open=e,this.open&&(o.openCount+=1),this.requestUpdate("open",!this.open)))}get state(){return this._state}set state(e){if(e===this.state)return;const t=this.state;this._state=e,(this.state==="opened"||this.state==="closed")&&(this.longpressState=this.longpressState==="pressed"?"null":this.longpressState),this.requestUpdate("state",t)}get usesDialog(){return this.type==="modal"||this.type==="page"}get popoverValue(){if("popover"in this)switch(this.type){case"modal":case"page":return;case"hint":return"manual";default:return this.type}}get requiresPosition(){return!(this.type==="page"||!this.open||!this.triggerElement||!this.placement&&this.type!=="hint")}managePosition(){if(!this.requiresPosition||!this.open)return;const e=this.offset||0,t=this.triggerElement,i=this.placement||"right",r=this.tipPadding;this.placementController.placeOverlay(this.dialogEl,{offset:e,placement:i,tipPadding:r,trigger:t,type:this.type})}async managePopoverOpen(){super.managePopoverOpen();const e=this.open;if(this.open!==e||(await this.manageDelay(e),this.open!==e)||(await this.ensureOnDOM(e),this.open!==e))return;const t=await this.makeTransition(e);this.open===e&&await this.applyFocus(e,t)}async applyFocus(e,t){if(!(this.receivesFocus==="false"||this.type==="hint")){if(await E(),await E(),e===this.open&&!this.open){this.hasNonVirtualTrigger&&this.contains(this.getRootNode().activeElement)&&this.triggerElement.focus();return}t==null||t.focus()}}async manageOpen(e){var t;if(!(!this.isConnected&&this.open)){if(this.hasUpdated||await this.updateComplete,this.open?(y.add(this),this.willPreventClose&&(document.addEventListener("pointerup",()=>{this.dialogEl.classList.toggle("not-immediately-closable",!1),this.willPreventClose=!1},{once:!0}),this.dialogEl.classList.toggle("not-immediately-closable",!0))):(e&&this.dispose(),y.remove(this)),this.open&&this.state!=="opened"?this.state="opening":!this.open&&this.state!=="closed"&&(this.state="closing"),this.usesDialog?this.manageDialogOpen():this.managePopoverOpen(),this.type==="auto"){const i=this.getRootNode();this.open?i.addEventListener("focusout",this.closeOnFocusOut,{capture:!0}):i.removeEventListener("focusout",this.closeOnFocusOut,{capture:!0})}if(!this.open&&this.type!=="hint"){const i=()=>{var p;const r=[];let s=document.activeElement;for(;s!=null&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;for(;s;){const a=s.assignedSlot||s.parentElement||((p=s.getRootNode())==null?void 0:p.host);a&&r.push(a),s=a}return r};(t=this.triggerElement)!=null&&t.focus&&(this.contains(this.getRootNode().activeElement)||i().includes(this))&&this.triggerElement.focus()}}}unbindEvents(){var e;(e=this.abortController)==null||e.abort()}bindEvents(){if(!this.hasNonVirtualTrigger)return;this.abortController=new AbortController;const e=this.triggerElement;switch(this.triggerInteraction){case"click":this.bindClickEvents(e);return;case"longpress":this.bindLongpressEvents(e);return;case"hover":this.bindHoverEvents(e);return}}bindClickEvents(e){const t={signal:this.abortController.signal};e.addEventListener("click",this.handleClick,t),e.addEventListener("pointerdown",this.handlePointerdownForClick,t)}bindLongpressEvents(e){const t={signal:this.abortController.signal};e.addEventListener("longpress",this.handleLongpress,t),e.addEventListener("pointerdown",this.handlePointerdown,t),this.prepareLongpressDescription(e),!e.holdAffordance&&(e.addEventListener("keydown",this.handleKeydown,t),e.addEventListener("keyup",this.handleKeyup,t))}bindHoverEvents(e){const t={signal:this.abortController.signal};e.addEventListener("focusin",this.handleFocusin,t),e.addEventListener("focusout",this.handleFocusout,t),e.addEventListener("pointerenter",this.handlePointerenter,t),e.addEventListener("pointerleave",this.handlePointerleave,t),this.addEventListener("pointerenter",this.handleOverlayPointerenter,t),this.addEventListener("pointerleave",this.handleOverlayPointerleave,t)}manageTriggerElement(e){e&&(this.unbindEvents(),this.releaseAriaDescribedby()),!(!this.triggerElement||this.triggerElement instanceof T)&&(this.bindEvents(),this.receivesFocus!=="true"&&this.prepareAriaDescribedby())}prepareLongpressDescription(e){if(this.triggerInteraction!=="longpress"||this.releaseLongpressDescribedby!==d||!this.elements.length)return;const t=document.createElement("div");t.id=`longpress-describedby-descriptor-${crypto.randomUUID().slice(0,8)}`;const i=A()||S()?"touch":"keyboard";t.textContent=LONGPRESS_INSTRUCTIONS[i],t.slot="longpress-describedby-descriptor";const r=e.getRootNode(),s=this.getRootNode();r===s?this.append(t):(t.hidden=!("host"in r),e.insertAdjacentElement("afterend",t));const p=g(e,"aria-describedby",[t.id]);this.releaseLongpressDescribedby=()=>{p(),t.remove(),this.releaseLongpressDescribedby=d}}prepareAriaDescribedby(){if(this.triggerInteraction!=="hover"||this.releaseAriaDescribedby!==d||!this.elements.length||!this.hasNonVirtualTrigger)return;const e=this.triggerElement,t=e.getRootNode(),i=this.elements[0].getRootNode(),r=this.getRootNode();if(t==r){const s=g(e,"aria-describedby",[this.id]);this.releaseAriaDescribedby=()=>{s(),this.releaseAriaDescribedby=d}}else if(t===i){this.elementIds=this.elements.map(a=>a.id);const s=this.elements.map(a=>(a.id||(a.id=`${this.tagName.toLowerCase()}-helper-${crypto.randomUUID().slice(0,8)}`),a.id)),p=g(e,"aria-describedby",s);this.releaseAriaDescribedby=()=>{p(),this.elements.map((a,L)=>{a.id=this.elementIds[L]}),this.releaseAriaDescribedby=d}}}doPointerleave(){this.pointerentered=!1;const e=this.triggerElement;this.focusedin&&e.matches(":focus-visible")||(this.hoverTimeout=setTimeout(()=>{this.open=!1},F))}handleBeforetoggle(e){e.newState!=="open"&&this.handleBrowserClose()}handleBrowserClose(){if(this.longpressState!=="opening"&&this.longpressState!=="pressed"){this.open=!1;return}this.manuallyKeepOpen()}manuallyKeepOpen(){super.manuallyKeepOpen(),this.open=!0,this.placementController.allowPlacementUpdate=!0,this.manageOpen(!1)}handleSlotchange(){this.triggerElement&&this.prepareAriaDescribedby(),this.elements.length?this.hasNonVirtualTrigger&&this.prepareLongpressDescription(this.triggerElement):this.releaseLongpressDescribedby()}shouldPreventClose(){const e=this.willPreventClose;return this.willPreventClose=!1,e}willUpdate(e){var i;if(this.hasAttribute("id")||this.setAttribute("id",`${this.tagName.toLowerCase()}-${crypto.randomUUID().slice(0,8)}`),e.has("open")&&(typeof e.get("open")!="undefined"||this.open)&&this.manageOpen(e.get("open")),e.has("trigger")){const[r,s]=((i=this.trigger)==null?void 0:i.split("@"))||[];this.elementResolver.selector=r?`#${r}`:"",this.triggerInteraction=s}const t=this.triggerElement;e.has(O)&&(this.triggerElement=this.elementResolver.element,this.manageTriggerElement(t)),e.has("triggerElement")&&this.manageTriggerElement(e.get("triggerElement"))}updated(e){super.updated(e),e.has("placement")&&(this.placement?this.dialogEl.setAttribute("actual-placement",this.placement):this.dialogEl.removeAttribute("actual-placement"),this.open&&typeof e.get("placement")!="undefined"&&this.placementController.resetOverlayPosition())}renderContent(){return u`
            <slot @slotchange=${this.handleSlotchange}></slot>
        `}get dialogStyleMap(){return{"--swc-overlay-open-count":o.openCount.toString()}}renderDialog(){return u`
            <dialog
                class="dialog"
                part="dialog"
                placement=${m(this.requiresPosition?this.placement||"right":void 0)}
                style=${b(this.dialogStyleMap)}
                @close=${this.handleBrowserClose}
                @cancel=${this.handleBrowserClose}
                @beforetoggle=${this.handleBeforetoggle}
                ?is-visible=${this.state!=="closed"}
            >
                ${this.renderContent()}
            </dialog>
        `}renderPopover(){return u`
            <div
                class="dialog"
                part="dialog"
                placement=${m(this.requiresPosition?this.placement||"right":void 0)}
                popover=${m(this.popoverValue)}
                style=${b(this.dialogStyleMap)}
                @beforetoggle=${this.handleBeforetoggle}
                @close=${this.handleBrowserClose}
                ?is-visible=${this.state!=="closed"}
            >
                ${this.renderContent()}
            </div>
        `}render(){const e=this.type==="modal"||this.type==="page";return u`
            ${e?this.renderDialog():this.renderPopover()}
            <slot name="longpress-describedby-descriptor"></slot>
        `}connectedCallback(){super.connectedCallback(),this.addEventListener("close",()=>{this.open=!1}),this.hasNonVirtualTrigger&&this.bindEvents()}disconnectedCallback(){this.hasNonVirtualTrigger&&this.unbindEvents(),this.releaseAriaDescribedby(),this.releaseLongpressDescribedby(),this.open=!1,super.disconnectedCallback()}};o.styles=[I],o.openCount=1,n([l({type:Boolean})],o.prototype,"delayed",1),n([f(".dialog")],o.prototype,"dialogEl",2),n([l({type:Boolean})],o.prototype,"disabled",1),n([C({flatten:!0,selector:':not([slot="longpress-describedby-descriptor"], slot)'})],o.prototype,"elements",2),n([l({type:Number})],o.prototype,"offset",2),n([l({type:Boolean,reflect:!0})],o.prototype,"open",1),n([l()],o.prototype,"placement",2),n([l({attribute:"receives-focus"})],o.prototype,"receivesFocus",2),n([f("slot")],o.prototype,"slotEl",2),n([D()],o.prototype,"state",1),n([l({type:Number,attribute:"tip-padding"})],o.prototype,"tipPadding",2),n([l()],o.prototype,"trigger",2),n([l({attribute:!1})],o.prototype,"triggerElement",2),n([l({attribute:!1})],o.prototype,"triggerInteraction",2),n([l()],o.prototype,"type",2);export let Overlay=o;
//# sourceMappingURL=Overlay.js.map
